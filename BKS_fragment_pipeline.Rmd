---
title: "Nsp3 fragment screen hit calling"
output: html_notebook
---

This notebook is dedicatedd to the development of a easily-used, reproducible pipeline for Nsp3 macrodomain hit calling. 
It is developed using data from fragment screens done with Stefan in the Shoichet lab.
It is part of a larger effort to identify ligands against Nsp3 mac1 domain. 
```{r}
library(quantmod) # contains the findValleys function, which maybe we should just extract and put verbatim in a source file instead of loading this whole thing...?
library(minpack.lm) # contains the nlsLM function, which we use for our fitting
library(modelr) # used in both the data modeling and the analysis model fitting 
library(SciViews) # contains the ln function used in the data modeling
library(signal) # contains the savistky golay filter (savgolfilt), used to generate the first derivative data in both data modeling and analysis model fitting  
library(ggrepel) # for plot labeling
library(dplyr)
library(purrr)
library(tidyverse)
source("scripts/analysis.R")
source("scripts/plotting.R")
source("scripts/screen_analysis.R")
filter <- dplyr::filter # filter is masked from dplyr by signal
as_vector <- purrr::as_vector
```


```{r}
# when you've messed up and need to swap out your layout. Ultimately, this really should not be used, as layout shouldn't be added during fitting (fitting results need not update when the layout does)
swap_layout <- function(df_raw, new_layout_file) {
  df_raw %>%
    select(variable:channel_f,Temperature_norm:value_norm_by_comp ) %>%
    left_join(make_layout(new_layout_file), by = "well")
  
}

process_screen <- function(DATA_PATH, 
                           LAYOUT_PATH, 
                           screen_name,
                           low_T = 25,
                           high_T = 94,
                           n_meas = 69,
                           ignore_vars = "",
                           fit_if = c("TAMRA", "FAM", "SyproOrange"),
                           save_fits = TRUE,
                           save_path = "",
                           save_name = "fits.rds",
                           temp_range = c(25, 85),
                           quick_look = TRUE
) {
  
  df_raw <- condition_qTower_raw(DATA_PATH, LAYOUT_PATH, screen_name, low_T) %>%
              filter(between(Temperature, temp_range[[1]], temp_range[[2]])) %>%
              mutate_all(convert_numerics)
  
  # if (quick_look = TRUE) {
  #   
  #   quick_look(df_raw, 
  #          .filter_vars = "channel == 'FAM' & dye == 'T004' & compound_group != 'test'", 
  #          color_var = compound_group, 
  #          plot_title = "Exp0858 Control Conditions, qTower FAM errored, unusable data \ndye = T004, channel =  FAM",
  #          linetype_values  = c("Nsp3" = "solid", "Buffer" = "dotted"))
  #   
  # } else if (quick_look = FALSE) {
    
     by_variable <- df_raw %>%
    nest(data = c(Temperature, value, channel, Temperature_norm, value_norm, value_norm_by_comp))
  
  fits <- find_tmas(by_variable_raw = by_variable,
                    low_T = low_T,
                    high_T = high_T,
                    n_meas = 69, #### THIS NEEDS TO BE FIXED! Sometimes throws an error in sgolayfilt odd requirement if set dynamically #df_raw$Temperature %>% unique() %>% length(),
                    filter_criteria = fit_if)
  
  outlist <- list(df_raw = df_raw,
                  by_variable = by_variable,
                  fits = fits)
  
  
  if (save_fits != FALSE) { paste0(SAVE_PATH, save_name)  %>% write_rds( . , x = outlist) }
  
  outlist 
  
  }
  


make_screen_process <- function(low_T = 25,
                                high_T = 94,
                                n_meas = 69,
                                ignore_vars = "protein == Empty",
                                fit_if = "channel_f %in% c('TAMRA', 'FAM', 'SyproOrange') & protein == 'SP0150_Nsp3'",
                                save_path = SAVE_PATH,
                                temp_range) {
  
  # the defined function contains all argument which you want the output function to have    
  function(DATA_PATH, 
           LAYOUT_PATH,
           screen_name,
           save_fits = TRUE,
           save_name
  ) {
    # this function includes assignments for all of the arguments passed to the closure, which will be set in the resulting function
    process_screen(DATA_PATH, 
                   LAYOUT_PATH,
                   screen_name,
                   save_fits = TRUE,
                   save_name,
                   low_T = low_T,
                   high_T = high_T,
                   n_meas = n_meas,
                   ignore_vars = ignore_vars,
                   fit_if = fit_if,
                   save_path = save_path,
                   temp_range = temp_range)
    
  } 
}

# create closure for this specific screen
MAIN_PATH <- "data/Exp0866--20200811_Nsp3_T004_SYPRO_fragment_all_batch_retest/"
LAYOUT_PATH <- MAIN_PATH %>% paste0("layouts/")
SAVE_PATH <- MAIN_PATH %>% paste0("out/")
layout_path_1 <- LAYOUT_PATH %>% paste0("Exp0865.1--20200811_Nsp3_mac1_fragments_batch1_layout.csv")
layout_path_2 <- LAYOUT_PATH %>% paste0("Exp0865.2--20200811_Nsp3_mac1_fragments_batch2_layout.csv")

process_FAM_screen <- make_screen_process(low_T = 25,
                                                high_T = 94,
                                                n_meas = 69,
                                                ignore_vars = "protein == 'Empty'",
                                                fit_if = "channel_f %in% c('FAM') & protein == 'SP0150_Nsp3'",
                                                save_path = SAVE_PATH,
                                                temp_range = c(25, 84)) 

process_TAMRA_screen <- make_screen_process(low_T = 25,
                                                high_T = 94,
                                                n_meas = 69,
                                                ignore_vars = "protein == 'Empty'",
                                                fit_if = "channel_f %in% c('TAMRA') & protein == 'SP0150_Nsp3'",
                                                save_path = SAVE_PATH,
                                                temp_range = c(25, 84)) 
```




```{r}
##### BIG PROBLEM TO FIX: WELL IS CONSIDERED THE UNIQUE VARIABLE HERE!!!!! so if you're doing multiple channels, everything falls apart.... silently ############

#### for now, only process one channel at a time ###

## ultimately, it would be good t be able to read in an excel file with all of these arguments, and apply the processing screen to them appropriately to avoid this n-plate duplication

SYPRO_batch_1 <- process_TAMRA_screen (DATA_PATH = MAIN_PATH %>% paste0("Exp0866_20200811_Nsp3_mac1_fragment_batch1_daughter_865p1_SYPRO.csv"), 
                                           LAYOUT_PATH = LAYOUT_PATH %>% paste0("Exp0865.1--20200811_Nsp3_mac1_fragments_batch1_layout.csv"),
                                           screen_name = "Exp866_batch1_SYPRO",
                                           save_fits = TRUE,
                                           save_name = "Exp866_batch1_SYPRO_fits.rds")

SYPRO_batch_2 <- process_TAMRA_screen (DATA_PATH = MAIN_PATH %>% paste0("Exp0866_20200811_Nsp3_mac1_fragment_batch2_daughter_865p2_SYPRO.csv"), 
                                         LAYOUT_PATH = LAYOUT_PATH %>% paste0("Exp0865.2--20200811_Nsp3_mac1_fragments_batch2_layout.csv"),
                                         screen_name = "Exp866_batch2_SYPRO",
                                         save_fits = TRUE,
                                         save_name = "Exp866_batch2_SYPRO_fits.rds")

T004_batch_1 <- process_FAM_screen (DATA_PATH = MAIN_PATH %>% paste0("Exp0866_20200811_Nsp3_mac1_fragment_batch1_daughter_865p1_T004.csv"), 
                                         LAYOUT_PATH = LAYOUT_PATH %>% paste0("Exp0865.1--20200811_Nsp3_mac1_fragments_batch1_layout.csv"),
                                         screen_name = "Exp866_batch1_T004",
                                         save_fits = TRUE,
                                         save_name = "Exp866_batch1_T004_fits.rds")

T004_batch_2 <- process_FAM_screen (DATA_PATH = MAIN_PATH %>% paste0("Exp0866_20200811_Nsp3_mac1_fragment_batch2_daughter_865p2_T004.csv"), 
                                         LAYOUT_PATH = LAYOUT_PATH %>% paste0("Exp0865.2--20200811_Nsp3_mac1_fragments_batch2_layout.csv"),
                                         screen_name = "Exp866_batch2_T004",
                                         save_fits = TRUE,
                                         save_name = "Exp866_batch2_T004_fits.rds")

# This message is displayed once per session. # but actually it gets displayed a lot?
# Note: Using an external vector in selections is ambiguous.
# ℹ Use `all_of(sub_info)` instead of `sub_info` to silence this message. ## Track these lines down
# ℹ See <https://tidyselect.r-lib.org/reference/faq-external-vector.html>.
```

```{r}
T004_batch_2$fits$s1_d_list$tm_models_all # has well and condition
T004_batch_2$fits$s1_d_list$tm_table_models # is averaged, and not what you want here!!
T004_batch_2$fits$s1_d_list$df_BIC # has well and condition, is not averaged, and is what you want
T004_batch_2$fits$df_tms # has wells, and dRFU tms 

# well is unique here! use that
merge_elements <- function(in_list) {
  df_list <-c("tm_models_all", "df_BIC")
  model_list <- c("s1_list", "s1_d_list", "s2_list", "s2_d_list")
  
  out <- list()
  for (df_element in df_list) {

    int <- lapply(model_list, function(x) in_list$fits[[x]][[df_element]])  %>%
              bind_rows() # bind together extracted df_element from all four models

    out <- list(out, int) # add that df_element to a list
  }
  
 dRFU_tmas  <- lapply(model_list, function(x) in_list$fits[["df_tms"]]) %>%
    bind_rows() %>%

    mutate(which_model = "dRFU") %>%
   rename(mean_tma1 = "dRFU_tma") %>%
      select(well, which_model, condition, mean_tma1) 
  
out_list <- list("model_tmas" = out[[1]][[2]],
                 "dRFU_tmas" = dRFU_tmas,
                 "df_BIC" = out[[2]])

}

T004_batch_1_fits <- merge_elements(T004_batch_1)
T004_batch_2_fits <- merge_elements(T004_batch_2)
SYPRO_batch_1_fits <- merge_elements(SYPRO_batch_1)
SYPRO_batch_2_fits <- merge_elements(SYPRO_batch_2)

T004_fits <- list("model_tmas" = bind_rows(T004_batch_1_fits$model_tmas %>% left_join(make_layout(layout_path_1), by = c("well", "condition")) %>% mutate(batch = "batch1"), 
                                           T004_batch_2_fits$model_tmas %>% left_join(make_layout(layout_path_2), by = c("well", "condition")) %>% mutate(batch = "batch2")%>%
  mutate(batch = recode(batch, "Verdiperstat" = "pre_approved",	
                                "kinetin" = "pre_approved", 
                                "irsogladine" = "pre_approved",	
                                "diaveridine" = "pre_approved",	
                                "N6-Benzyladenine" = "pre_approved", 
                                "ZINC1383151 / PP2" = "pre_approved",	
                                "temodal" = "pre_approved",
                        "DMSO" = "control",
                        "ADP_ribose" = "control"))),
                  "dRFU_tmas" = bind_rows(T004_batch_1_fits$dRFU_tmas %>% left_join(make_layout(layout_path_1), by = c("well", "condition")) %>% mutate(batch = "batch1"), 
                                          T004_batch_2_fits$dRFU_tmas %>% left_join(make_layout(layout_path_2), by = c("well", "condition")) %>% mutate(batch = "batch2")%>%
  mutate(batch = recode(batch, "Verdiperstat" = "pre_approved",	
                                "kinetin" = "pre_approved", 
                                "irsogladine" = "pre_approved",	
                                "diaveridine" = "pre_approved",	
                                "N6-Benzyladenine" = "pre_approved", 
                                "ZINC1383151 / PP2" = "pre_approved",	
                                "temodal" = "pre_approved",
                        "DMSO" = "control",
                        "ADP_ribose" = "control"))),
                  "df_BIC" = bind_rows(T004_batch_1_fits$df_BIC %>% left_join(make_layout(layout_path_1), by = c("well", "condition")) %>% mutate(batch = "batch1"), 
                                       T004_batch_2_fits$df_BIC %>% left_join(make_layout(layout_path_2), by = c("well", "condition")) %>% mutate(batch = "batch2"))%>%
  mutate(batch = recode(batch, "Verdiperstat" = "pre_approved",	
                                "kinetin" = "pre_approved", 
                                "irsogladine" = "pre_approved",	
                                "diaveridine" = "pre_approved",	
                                "N6-Benzyladenine" = "pre_approved", 
                                "ZINC1383151 / PP2" = "pre_approved",	
                                "temodal" = "pre_approved",
                        "DMSO" = "control",
                        "ADP_ribose" = "control")))

SYPRO_fits <- list("model_tmas" = bind_rows(SYPRO_batch_1_fits$model_tmas %>% left_join(make_layout(layout_path_1), by = c("well", "condition")) %>% mutate(batch = "batch1"), 
                                            SYPRO_batch_2_fits$model_tmas %>% left_join(make_layout(layout_path_2), by = c("well", "condition")) %>% mutate(batch = "batch2")%>%
  mutate(batch = recode(batch, "Verdiperstat" = "pre_approved",	
                                "kinetin" = "pre_approved", 
                                "irsogladine" = "pre_approved",	
                                "diaveridine" = "pre_approved",	
                                "N6-Benzyladenine" = "pre_approved", 
                                "ZINC1383151 / PP2" = "pre_approved",	
                                "temodal" = "pre_approved",
                        "DMSO" = "control",
                        "ADP_ribose" = "control"))),
                  "dRFU_tmas" = bind_rows(SYPRO_batch_1_fits$dRFU_tmas %>% left_join(make_layout(layout_path_1), by = c("well", "condition")) %>% mutate(batch = "batch1"), 
                                          SYPRO_batch_2_fits$dRFU_tmas %>% left_join(make_layout(layout_path_2), by = c("well", "condition")) %>% mutate(batch = "batch2")%>%
  mutate(batch = recode(batch, "Verdiperstat" = "pre_approved",	
                                "kinetin" = "pre_approved", 
                                "irsogladine" = "pre_approved",	
                                "diaveridine" = "pre_approved",	
                                "N6-Benzyladenine" = "pre_approved", 
                                "ZINC1383151 / PP2" = "pre_approved",	
                                "temodal" = "pre_approved",
                        "DMSO" = "control",
                        "ADP_ribose" = "control"))),
                  "df_BIC" = bind_rows(SYPRO_batch_1_fits$df_BIC %>% left_join(make_layout(layout_path_1), by = c("well", "condition")) %>% mutate(batch = "batch1"), 
                                       SYPRO_batch_2_fits$df_BIC %>% left_join(make_layout(layout_path_2), by = c("well", "condition")) %>% mutate(batch = "batch2")%>%
  mutate(batch = recode(batch, "Verdiperstat" = "pre_approved",	
                                "kinetin" = "pre_approved", 
                                "irsogladine" = "pre_approved",	
                                "diaveridine" = "pre_approved",	
                                "N6-Benzyladenine" = "pre_approved", 
                                "ZINC1383151 / PP2" = "pre_approved",	
                                "temodal" = "pre_approved",
                        "DMSO" = "control",
                        "ADP_ribose" = "control"))))

all_fits <- list( "model_tmas" = bind_rows(SYPRO_fits$model_tmas %>% mutate(dye = "SYPRO"),
                                           T004_fits$model_tmas %>% mutate(dye = "T004")),
                  "dRFU_tmas" = bind_rows(SYPRO_fits$dRFU_tmas %>% mutate(dye = "SYPRO"),
                                           T004_fits$dRFU_tmas %>% mutate(dye = "T004")),
                  "df_BIC" = bind_rows(SYPRO_fits$df_BIC %>% mutate(dye = "SYPRO"),
                                           T004_fits$df_BIC %>% mutate(dye = "T004"))) 


model_tmas <- all_fits$model_tmas %>% 
  ungroup() %>%
  mutate(batch = case_when( (compound %in% c("Verdiperstat",	"kinetin", "irsogladine",  "diaveridine" ,"N6-Benzyladenine", "ZINC1383151 / PP2" , "temodal")) ~ "pre_approved",
                             (compound %in% c("ADP_ribose")) ~ "pos_control",
                            (compound %in% c("DMSO")) ~ "neg_control",
                              TRUE ~ batch)) %>%
    mutate(batch = factor(batch, levels = c("pos_control", "neg_control", "pre_approved", "batch1", "batch2"))) %>%
  arrange(batch) %>%
     mutate(compound_f = factor(compound, levels = compound %>% unique()))

additional_row <- model_tmas[1,] %>%
                  mutate(condition = "one",
                         mean_tma1 = NA,
                         dye = "T004") 
additional_row

model_tmas %>%
    filter(compound_group != "Empty",
         which_model == "s1_d_pred",
         dye == "T004") %>%
  group_by(batch) %>%
  tally()

"DMSO_DMSO_0_SP0150_Nsp3_750"
"temodal_test_50_SP0150_Nsp3_750"
"ZINC000649348648_test_30_SP0150_Nsp3_750"
```
```{r}
## define some of the means and SDs 
all_fits$model_tmas %>%
  filter(compound_group != "Empty",
         which_model == "s1_d_pred",
         dye == "T004",
         between(mean_tma1, 40, 60)) %>%
  group_by(compound_group) %>%
  summarise(mean_tma = mean(mean_tma1),
            sd_tma = sd(mean_tma1))

all_fits$model_tmas %>%
  filter(compound_group != "Empty",
         which_model == "s1_d_pred",
         dye == "SYPRO",
         between(mean_tma1, 40, 60)) %>%
  group_by(compound_group) %>%
  summarise(mean_tma = mean(mean_tma1),
            sd_tma = sd(mean_tma1))
```


```{r}
model_tmas %>%
  filter(compound_group != "Empty",
         which_model == "s1_d_pred",
         dye == "SYPRO") %>%
  ggplot(aes(x = compound_f, y = mean_tma1, color = batch, shape = concentration %>% as.character(), size = concentration %>% as.character(), group = compound)) + # 
  #scale_shape_manual(values = c("DMSO" = 1, "ADP_ribose" = 1, "test" = 16)) +
  scale_shape_manual(values = c(16,16,16,16,1,16,1)) +
  scale_size_manual(values = c(1,3,3,3,1.5,3,1.5)) +  
  scale_color_manual(values = c("black", "black","#7570b3", "#1b9e77", "#d95f02"))+
  
  geom_vline(xintercept = "DMSO", color = "grey", size = 0.5, alpha = 0.5) +
  geom_vline(xintercept = "temodal", color = "grey", size = 0.5, alpha = 0.5) +
  geom_vline(xintercept = "ZINC000649348648", color = "grey", size = 0.5, alpha = 0.5) + 
  
  
  
  geom_hline(yintercept = 50.36, color = "grey", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 53.94, color = "grey", size = 0.5, alpha = 0.5) +
  
  geom_hline(yintercept = 51.04535 + 3*0.1, color = "black", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 51.04535, color = "black", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 51.04535 - 3*0.1, color = "black", size = 0.5, alpha = 0.5) +
  #geom_ribbon(aes(ymin = 50.09 - 3*0.2, ymax = 50.09 + 3*0.2), fill="blue", color = "blue",  alpha=0.5) +
  
  geom_line(size = 1, alpha = 0.7)+
      geom_point(alpha = 0.7) +
      theme_bw() +
      theme(axis.text.x = element_blank()) +
  ylim(c(47.5, 55)) +
  theme(panel.grid = element_blank()) +
 # facet_wrap(~control_or_test, ncol = 2, scales = "free_x") +
  labs(title = "Exp0866--20200815_T004_s1d_tma_scatter", y = "Tma (ºC)", x = "Compound") -> p
ggsave("Exp0866--20200815_SYPRO_s1d_tma_scatter_facet.pdf",  p, width = 12, height = 4)


model_tmas %>%
  filter(compound_group != "Empty",
         which_model == "s1_d_pred",
         dye == "T004") %>%
  ggplot(aes(x = compound_f, y = mean_tma1, color = batch, shape = concentration %>% as.character(), size = concentration %>% as.character(), group = compound)) + # 
  #scale_shape_manual(values = c("DMSO" = 1, "ADP_ribose" = 1, "test" = 16)) +
  scale_shape_manual(values = c(16,16,16,16,1,16,1)) +
  scale_size_manual(values = c(1,3,3,3,1.5,3,1.5)) +  
  scale_color_manual(values = c("black", "black","#7570b3", "#1b9e77", "#d95f02"))+
  
  geom_vline(xintercept = "DMSO", color = "grey", size = 0.5, alpha = 0.5) +
  geom_vline(xintercept = "temodal", color = "grey", size = 0.5, alpha = 0.5) +
  geom_vline(xintercept = "ZINC000649348648", color = "grey", size = 0.5, alpha = 0.5) + 
  
  
  
  geom_hline(yintercept = 52.00000, color = "grey", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 54.90000, color = "grey", size = 0.5, alpha = 0.5) +
  
  geom_hline(yintercept = 50.09 + 3*0.2, color = "black", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 50.09, color = "black", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 50.09 - 3*0.2, color = "black", size = 0.5, alpha = 0.5) +
  #geom_ribbon(aes(ymin = 50.09 - 3*0.2, ymax = 50.09 + 3*0.2), fill="blue", color = "blue",  alpha=0.5) +
  
  geom_line(size = 1, alpha = 0.7)+
      geom_point(alpha = 0.7) +
      theme_bw() +
      theme(axis.text.x = element_blank()) +
  ylim(c(47.5, 55)) +
  theme(panel.grid = element_blank()) +
 # facet_wrap(~control_or_test, ncol = 2, scales = "free_x") +
  labs(title = "Exp0866--20200815_T004_s1d_tma_scatter", y = "Tma (ºC)", x = "Compound") -> p2
ggsave("Exp0866--20200815_T004_s1d_tma_scatter_facet.pdf",  p2, width = 12, height = 4)


model_tmas %>%
  filter(compound_group != "Empty",
         which_model == "s1_d_pred") %>%
  ggplot(aes(x = compound_f, y = mean_tma1, color = batch, shape = concentration %>% as.character(), size = concentration %>% as.character(), group = compound)) + # 
  #scale_shape_manual(values = c("DMSO" = 1, "ADP_ribose" = 1, "test" = 16)) +
  scale_shape_manual(values = c(16,16,16,16,1,16,1)) +
  scale_size_manual(values = c(1,3,3,3,1.5,3,1.5)) +  
  scale_color_manual(values = c("black", "black","#7570b3", "#1b9e77", "#d95f02"))+
  
  geom_vline(xintercept = "DMSO", color = "grey", size = 0.5, alpha = 0.5) +
  geom_vline(xintercept = "temodal", color = "grey", size = 0.5, alpha = 0.5) +
  geom_vline(xintercept = "ZINC000649348648", color = "grey", size = 0.5, alpha = 0.5) + 
  
  
  
  geom_hline(yintercept = 50.36, color = "grey", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 53.94, color = "grey", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 50.09 + 3*0.2, color = "black", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 50.09, color = "black", size = 0.5, alpha = 0.5) +
  geom_hline(yintercept = 50.09 - 3*0.2, color = "black", size = 0.5, alpha = 0.5) +
  #geom_ribbon(aes(ymin = 50.09 - 3*0.2, ymax = 50.09 + 3*0.2), fill="blue", color = "blue",  alpha=0.5) +
  
  geom_line(size = 1, alpha = 0.7)+
      geom_point(alpha = 0.7) +
      theme_bw() +
      theme(axis.text.x = element_blank()) +
  ylim(c(47.5, 55)) +
  theme(panel.grid = element_blank()) +
 facet_wrap(~dye, ncol = 1) +
  labs(title = "Exp0866--20200815_SYPRO_T004_s1d_tma_scatter", y = "Tma (ºC)", x = "Compound") -> p3
ggsave("Exp0866--20200815_SYPRO_s1d_tma_scatter_facet.pdf",  p3, width = 12, height = 6)
```

```{r}
all_fits$dRFU_tmas %>%
  filter(compound_group != "Empty") %>%
  ggplot(aes(x = condition, y = mean_tma1, color = dye, shape = compound_group)) +
  scale_shape_manual(values = c("DMSO" = 1, "ADP_ribose" = 1, "test" = 16)) +
      geom_point(alpha = 0.5) +
      theme_bw() +
      theme(axis.text.x = element_blank()) +
  ylim(c(40,60))


all_fits$model_tmas %>%
  filter(compound_group != "Empty",
         which_model == "s1_d_pred") %>%
  ggplot(aes(x = condition, y = mean_tma1, color = dye, shape = compound_group)) +
  scale_shape_manual(values = c("DMSO" = 1, "ADP_ribose" = 1, "test" = 16)) +
      geom_point(alpha = 0.5) +
      theme_bw() +
      theme(axis.text.x = element_blank()) +
  ylim(c(40,60))

```

```{r}
all_fits$model_tmas %>%
  filter(compound_group != "Empty",
         which_model == "s1_d_pred",
         dye == "T004",
         between(mean_tma1, 40, 60)) %>%
  group_by(compound_group) %>%
  summarise(mean_tma = mean(mean_tma1),
            sd_tma = sd(mean_tma1))
  

all_fits$model_tmas %>%
  filter(compound_group != "Empty",
         which_model == "s1_d_pred") %>%
  mutate(dye_compound = paste0(dye, compound, sep = "_")) %>%
  ggplot(aes(x = condition, y = mean_tma1, color = dye, shape = concentration %>% as.character(), size = concentration %>% as.character(), group = dye_compound)) + # 
  #scale_shape_manual(values = c("DMSO" = 1, "ADP_ribose" = 1, "test" = 16)) +
  scale_shape_manual(values = c(16,16,16,16,1,16,1)) +
  scale_size_manual(values = c(1,3,3,3,1.5,3,1.5)) +  
  geom_hline(yintercept = 50.36, color = "grey", size = 0.5) +
  geom_hline(yintercept = 53.94, color = "grey", size = 0.5) +
  
  geom_hline(yintercept = 50.09 + 3*0.2, color = "red", size = 0.5) +
  geom_hline(yintercept = 50.09, color = "red", size = 0.5) +
  geom_hline(yintercept = 50.09 - 3*0.2, color = "red", size = 0.5) +
  
  geom_line(size = 0.5, alpha = 0.5)+
      geom_point(alpha = 0.5) +
      theme_bw() +
      theme(axis.text.x = element_blank()) +
  ylim(c(47.5, 55)) +
 # facet_wrap(~dye, ncol = 1) +
  labs(title = "Exp0866--20200815_SYPRO_T004_s1d_tma_scatter", y = "Tma (ºC)", x = "Compound") -> p_facet


ggsave("Exp0866--20200815_SYPRO_T004_s1d_tma_scatter.pdf", p_facet, width = 12, height = 4)
```



```{r}
install.packages("ggpubr")
library(ggpubr)

ggscatterhist(
  all_fits$model_tmas %>% filter(compound_group != "Empty",
                                 which_model == "s1_d_pred",
                                 dye == "T004"), 
  x = "condition", y = "mean_tma1",
  color = "compound_group", size = 3, alpha = 0.6,
  palette = c("#00AFBB", "#E7B800", "#FC4E07"),
  margin.params = list(fill = "compound_group", color = "black", size = 0.2)
  )
```


```{r}
all_fits_wide <- all_fits$model_tmas %>%
  filter(which_model == "s1_d_pred",
         compound_group != "Empty") %>% ##compound_group == "test",
         
  select(-sigmoid_1) %>% 
  mutate(well_condition = paste0(well, condition, sep = "_")) %>%
  pivot_wider(names_from = dye, values_from = mean_tma1, values_fn = mean )
all_fits_wide 

all_fits_wide %>%
 ggplot(aes(x = T004, y = SYPRO, color = compound_group, shape = concentration %>% as.character(), size = concentration %>% as.character(), group = compound)) + # 
  #scale_shape_manual(values = c("DMSO" = 1, "ADP_ribose" = 1, "test" = 16)) +
  scale_shape_manual(values = c(16,16,16,16,1,16,1)) +
  scale_size_manual(values = c(1,3,3,3,1.5,3,1.5)) +  

  
  geom_line(size = 0.5, alpha = 0.5)+
      geom_point(alpha = 0.5) +
      theme_bw() +
      theme(axis.text.x = element_blank()) +
  ylim(c(47.5, 55)) +
   xlim(c(47.5, 55)) +
  coord_fixed() +
  geom_abline(slope = 1, intercept = 0) +
 # facet_wrap(~dye, ncol = 1) +
  labs(title = "Exp0866--20200815_SYPRO_T004_tma_comparision_s1d", y = "SYPRO", x = "T004") -> p_compare

p_compare


all_fits_wide <- all_fits$model_tmas %>%
  filter(compound_group != "test",
         which_model == "s1_d_pred") %>%
  select(-sigmoid_1) %>% 
  pivot_wider(names_from = dye, values_from = mean_tma1)

```

Quick data exploration
```{r}
##### work this into the processing script!!!! you should be able to checkpoint during processing to pass a temperature filter if necessary prior to fitting 
quick_look <- function(df, 
                       filter_vars, 
                       color_var, 
                       plot_title = "", 
                       linetype_values,
                       xvar = Temperature, 
                       yvar = value
                       ) {
  ### from advanced R, and probably a reason to think about the way we do flexible filtering right now
  # If you find yourself working with strings containing code very frequently, you should reconsider your process. Read Chapter 19 and consider whether you can generate expressions using quasiquotation more safely.
  
  df %>%
    filter( !!rlang::parse_expr(.filter_vars) ) %>%
    
    ggplot(aes(x = {{xvar}}, y = {{yvar}}, group = variable, color = {{color_var}}, linetype = protein)) +
        scale_linetype_manual(values = linetype_values) +
        geom_line(alpha = 0.5) +
        labs(x = "Temperature", y = "RFU", title = plot_title)
  
}

quick_look(T004_batch_1$df_raw %>% filter( between(Temperature, 30, 86), protein != "Empty") , 
           .filter_vars = "channel == 'FAM'", # & dye == 'T004' & compound_group != 'test'", 
           color_var = compound_group, 
           plot_title = "Exp0866 T004 with Batch 2 compounds  \ndye = T004, channel =  FAM",
           linetype_values  = c( "SP0150_Nsp3" = "solid", "Buffer" = "dotted"))
```

Re-entry: read in the processe screens
```{r}
# T004_batch_1 = readRDS(MAIN_PATH %>% paste0("out/Exp866_batch1_T004_fits.rds"))
# T004_batch_2 = readRDS(MAIN_PATH %>% paste0("out/Exp866_batch2_T004_fits.rds"))
# SYPRO_batch_1 = readRDS(MAIN_PATH %>% paste0("out/Exp866_batch1_SYPRO_fits.rds"))
# SYPRO_batch_2 = readRDS(MAIN_PATH %>% paste0("out/Exp866_batch2_SYPRO_fits.rds"))
```

Make some plots using model tmas
```{r}

make_tm_table <- function( model_results, which_model) {
  
  df <- model_results %>%
        filter(which_model == which_model,
               compound_group != "Empty") %>%
        select(compound_group, mean_tma1, BIC) %>%
        group_by(compound_group) %>%
        summarise(mean_tma = mean(mean_tma1),
                  sd_tma = sd(mean_tma1),
                  mean_BIC = mean(BIC),
                  sd_BIC = sd(BIC))
  
  out <- list(df = df,
              DMSO_tm = as_vector(df[2, "mean_tma"]),
              ADP_ribose_tm = as_vector(df[1, "mean_tma"]),
              DMSO_sd = as_vector(df[2, "sd_tma"]),
              ADP_ribose_sd = as_vector(df[1, "sd_tma"]),
              
              test_tm = as_vector(df[3, "mean_tma"])
              
              )
  
}

## T004
T004_fits %>% 
  filter(compound_group == "DMSO",
         which_model == "s1_d_pred") #head()
# 50.6 +/- 0.3

T004_fits %>% 
  filter(compound_group == "ADP_ribose",
         which_model == "s1_d_pred") #head()
# 54.0 +/- 0.1

T004_fits %>% 
  filter(compound_group == "test",
         between(mean_tma1 , 45, 55),
         which_model == "s1_d_pred") %>%
          summarise(mean_tma = mean(mean_tma1),
                    sd_tma = sd(mean_tma1))#head()
# 50.13 +/- 0.8

## SYPRO
SYPRO_fits %>% 
  filter(compound_group == "DMSO",
         which_model == "s1_d_pred") #head()
# 52 +/-	0.3	

SYPRO_fits %>% 
  filter(compound_group == "ADP_ribose",
         which_model == "s1_d_pred") #head()
# 54.9 +/-	0.1

SYPRO_fits %>% 
  filter(compound_group == "test",
         between(mean_tma1 , 45, 55),
         which_model == "s1_d_pred") %>%
          summarise(mean_tma = mean(mean_tma1),
                    sd_tma = sd(mean_tma1))#head()
# 51.11873 +/- 0.8419597

# of this i am deeply  NOT proud!!!
# functionalize this!!!
summary_tms <- tribble(
  ~dye,  ~mean_DMSO, ~sd_DMSO, ~mean_ADP_ribose, ~sd_ADP_ribose, ~mean_test,   ~sd_test,
  "T004",  50.6,        0.3,        54.0,          0.1,              50.13,       0.80,
  "SYPRO", 52.0,        0.3,        54.9,          0.1,              51.11,       0.84
)

summary_tms 
```
Screening figures with hlines
```{r}


SYPRO_fits %>%
  filter(compound_group != "Empty",
               which_model == "s1_d_pred") %>%
 ggplot(aes(x = compound, y = mean_tma1, color = compound_group, group = compound, shape = concentration %>% as.character(), size = concentration %>% as.character())) +
  scale_shape_manual(values = c(16, 16, 16, 1, 16, 1, 1)) +
  scale_size_manual(values = c(3, 3, 3, 1.5, 3, 1.5, 1)) +
  geom_point( alpha = 0.5) +
  geom_line(size=  0.5, alpha = 0.5) +
    theme_bw() +
  theme(axis.text.x = element_blank()) +
  ylim(c(40, 55)) +
  geom_hline( yintercept = summary_tms$mean_DMSO[2], color = "grey") +
    geom_hline( yintercept = summary_tms$mean_test[2] , color = "red") +
  geom_hline( yintercept = summary_tms$mean_test[2] + 3*summary_tms$sd_DMSO[2], color = "red") +
  geom_hline( yintercept = summary_tms$mean_test[2] - 3*summary_tms$sd_DMSO[2], color = "red") +
  labs(title = "SYPRO Model 2 Tmas") -> SYPRO_p


T004_fits %>%
        filter(compound_group != "Empty",
               which_model == "s1_d_pred") %>%
         ggplot(aes(x = compound, y = mean_tma1, color = compound_group, group = compound, shape = concentration %>% as.character(), size = concentration %>% as.character())) +
          scale_shape_manual(values = c(16, 16, 16, 1, 16, 1, 1)) +
          scale_size_manual(values = c(3, 3, 3, 1.5, 3, 1.5, 1)) +
          geom_point( alpha = 0.5) +
          geom_line(size=  0.5, alpha = 0.5) +
            theme_bw() +
          theme(axis.text.x = element_blank()) +
         # ylim(c(40, 55)) +
          geom_hline( yintercept = summary_tms$mean_DMSO[1], color = "grey") +
            geom_hline( yintercept = summary_tms$mean_test[1] , color = "red") +
          geom_hline( yintercept = summary_tms$mean_test[1] + 3*summary_tms$sd_DMSO[1], color = "red") +
          geom_hline( yintercept = summary_tms$mean_test[1] - 3*summary_tms$sd_DMSO[1], color = "red") +
          labs(title = "T004 Model 2 Tmas") -> T4_p

all_fits <-bind_rows(T004_fits %>% mutate(dye = "T004"),
                     SYPRO_fits %>% mutate(dye = "SYPRO"))

all_fits %>%
        filter(compound_group != "Empty",
               which_model == "s1_d_pred") %>%
         ggplot(aes(x = compound, y = mean_tma1, color = dye, group = compound, shape = concentration %>% as.character(), size = concentration %>% as.character())) +
          # scale_shape_manual(values = c(16, 16, 16, 1, 16, 1, 1)) +
          # scale_size_manual(values = c(3, 3, 3, 1.5, 3, 1.5, 1)) +
          scale_shape_manual(values = c(1, 1, 1, 16, 1, 16, 16)) +
          scale_size_manual(values = c(1.5, 1.5, 1.5, 3, 1.5, 3, 1)) +
          geom_point( alpha = 0.5) +
          geom_line(size=  0.5, alpha = 0.5) +
            theme_bw() +
          theme(axis.text.x = element_blank()) +
         ylim(c(40, 55)) +
          # geom_hline( yintercept = summary_tms$mean_DMSO[1], color = "grey") +
          #   geom_hline( yintercept = summary_tms$mean_test[1] , color = "red") +
          # geom_hline( yintercept = summary_tms$mean_test[1] + 3*summary_tms$sd_DMSO[1], color = "red") +
          # geom_hline( yintercept = summary_tms$mean_test[1] - 3*summary_tms$sd_DMSO[1], color = "red") +
          labs(title = " Model 2 Tmas") -> p
ggsave("all_dyes_tms.pdf", p,width = 15, height = 4)

p +
  facet_wrap(~dye, ncol = 1) -> p2
ggsave("all_dyes_facet_tms.pdf", p2,width = 15, height = 6)
```

```{r}
all_fits %>%
 # filter(compound_group == "test") %>%
  select(compound, compound_group, concentration, mean_tma1, dye, condition, well, which_model) %>%
  pivot_wider(names_from = dye, values_from = mean_tma1)  %>%
#    bind_rows(all_controls) %>%
  # ggplot(aes(y = T004, x = SYPRO,  group = compound, color = compound_group, shape = concentration %>% as.character(), size = concentration %>% as.character())) +
   ggplot(aes(y = T004, x = SYPRO,  group = compound, color = compound_group)) +
  # scale_shape_manual(values = c(16, 16, 1, 1, 1, 1)) +
  # scale_size_manual(values = c(2, 2, 3, 1.5, 3, 1.5)) +
  geom_line(size = 0.5, alpha = 0.7) +
  #ggplot(aes(x = T004, y = SYPRO)) +
  geom_point(alpha = 0.7) +
  coord_fixed() +
  ylim(c(47.5, 55)) +
  xlim(c(47.5, 55)) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5)
```

```{r}
T004_model_results %>% 
  arrange(which_model)
  select(which_model, BIC, condition, well) %>%
  arrange(which_model)
%>%
  pivot_wider(names_from = which_model, values_from = BIC)
```




```{r}
.protein_name <- "SP0150_Nsp3"

  protein_wells <- T004_batch_2$df_raw %>%
                      group_by(channel, compound, well, compound_group, protein) %>%
                      nest() %>%
                      select(-data) %>%
                      arrange(channel, compound,  compound_group, protein) %>%
                    
                      filter(compound_group == "test") %>% # this is something we'll need to fix later... 
                      pivot_wider(  names_from = protein, values_from = well) %>% #### YOU NEED THE NAME OF YOUR PROTEIN HERE!
                      mutate(protein_well = {{.protein_name}}) %>%
                      pivot_longer(protein_well, values_to = "protein_well") %>%
                      extract({{.protein_name}}, into = c("protein_row", "protein_column"), "^([A-Z]+)(\\d+)$")
  
  df_protein_wells_merge <- T004_batch_2$df_raw %>%
  left_join( . , protein_wells, by = make_string_list(channel, compound,  compound_group))



  df_control <- T004_batch_2$df_raw %>%
                filter(!!rlang::parse_expr(filter_control_vars)) %>%
                select(-{{.drop_control_cols}}) %>%
                filter( !!rlang::parse_expr(.filter_vars) ) %>%
                mutate_all(convert_numerics)
```


Plot all of the raw screening data, overlaying controls and test compounds. 
Arrange the plots by their position in the plate. 
```{r}
full_plate_view <- function(df_raw, 
                            .filter_vars, 
                            .color_var = compound_group, 
                            linetype_values,
                            
                            #optional inputs
                            plot_title = "", 
                            .xvar = Temperature, 
                            .yvar = value_norm_by_comp,
                            .protein_name,  # the name of the protein in the layout
                            filter_control_vars = "compound_group != 'test' & compound != 'Empty'",
                            .drop_control_cols = c(protein_row, protein_column) #c(row, columns)
                       ) {
  
   protein_wells <- df_raw %>%
                      group_by(channel, compound, well, compound_group, protein, concentration) %>%
                      nest() %>%
                      select(-data) %>%
                      arrange(channel, compound,  compound_group, protein, concentration) %>%
                    
                      filter(compound_group == "test") %>% # this is something we'll need to fix later... 
                      pivot_wider(  names_from = protein, values_from = well) %>% #### YOU NEED THE NAME OF YOUR PROTEIN HERE!
                      mutate(protein_well = {{.protein_name}}) %>%
                      pivot_longer(protein_well, values_to = "protein_well") %>%
                      extract({{.protein_name}}, into = c("protein_row", "protein_column"), "^([A-Z]+)(\\d+)$")
  
  df <- df_raw %>%
  left_join( . , protein_wells, by = make_string_list(channel, compound,  compound_group, concentration))

  df_control <- df %>%
                filter(!!rlang::parse_expr(filter_control_vars)) %>%
                select(-{{.drop_control_cols}}) %>%
                filter( !!rlang::parse_expr(.filter_vars) ) %>%
                mutate_all(convert_numerics)

  df %>%
    filter( !!rlang::parse_expr(.filter_vars) ) %>%
    filter(is.na(protein_well) == FALSE,
           is.na(protein_column) == FALSE) %>%
    
    mutate_all(convert_numerics) %>%

    ggplot(aes(x = {{.xvar}}, y = {{.yvar}}, group = variable, color = {{.color_var}}, linetype = protein)) +

    geom_line(data = df_control, aes(x = {{.xvar}}, y = {{.yvar}}, group = variable, color = {{.color_var}}, linetype = protein), size = 0.1, alpha = 0.3) +
    scale_color_manual(values = c("DMSO" = "blue", "ADP_ribose" = "black", "test" = "red")) +
        
    geom_line(alpha = 1) +
        scale_linetype_manual(values = linetype_values) +
        facet_grid(protein_row~protein_column) +
        labs(x = "Temperature", y = "RFU", title = plot_title) -> p
}



full_plate_view(df = T004_batch_2$df_raw, 
                .filter_vars = "channel == 'FAM'", # & dye == 'SYPRO' & compound != 'Empty' ", 

                plot_title = "Exp0866--20200815_Nsp3_fragment_batch2_all_compounds_T004_FAM", 
                linetype_values = c("SP0150_Nsp3" = "solid", "Buffer" = "dashed"),
                 .protein_name = "SP0150_Nsp3"
                ) %>%
      ggsave(paste0(SAVE_PATH, "Exp0866--20200815_Nsp3_fragment_batch2_all_compounds_T004_FAM.pdf"), . , width = 25, height = 7 )


full_plate_view(df = T004_batch_1$df_raw, 
                .filter_vars = "channel == 'FAM'", # & dye == 'SYPRO' & compound != 'Empty' ", 

                plot_title = "Exp0866--20200815_Nsp3_fragment_batch1_all_compounds_T004_FAM", 
                linetype_values = c("SP0150_Nsp3" = "solid", "Buffer" = "dashed"),
                 .protein_name = "SP0150_Nsp3"
                ) %>%
      ggsave(paste0(SAVE_PATH, "Exp0866--20200815_Nsp3_fragment_batch1_all_compounds_T004_FAM.pdf"), . , width = 25, height = 7 )

full_plate_view(df = SYPRO_batch_2$df_raw, 
                .filter_vars = "channel == 'TAMRA'", # & dye == 'SYPRO' & compound != 'Empty' ", 

                plot_title = "Exp0866--20200815_Nsp3_fragment_batch2_all_compounds_SYPRO_TAMRA", 
                linetype_values = c("SP0150_Nsp3" = "solid", "Buffer" = "dashed"),
                 .protein_name = "SP0150_Nsp3"
                ) %>%
      ggsave(paste0(SAVE_PATH, "Exp0866--20200815_Nsp3_fragment_batch2_all_compounds_SYPRO_TAMRA.pdf"), . , width = 25, height = 7 )

full_plate_view(df = SYPRO_batch_1$df_raw, 
                .filter_vars = "channel == 'FAM'", # & dye == 'SYPRO' & compound != 'Empty' ", 

                plot_title = "Exp0866--20200815_Nsp3_fragment_batch2_all_compounds_SYPRO", 
                linetype_values = c("SP0150_Nsp3" = "solid", "Buffer" = "dashed"),
                 .protein_name = "SP0150_Nsp3"
                ) %>%
      ggsave(paste0(SAVE_PATH, "Exp0866--20200815_Nsp3_fragment_batch1_all_compounds_SYPRO_TAMRA.pdf"), . , width = 25, height = 7 )
```


Make Tma scatter plots
```{r}
SYPRO_batch1_tms <- SYPRO_batch_1$fits$df_tms %>%
    select(variable:channel_f,dRFU_tma) %>%
  left_join(make_layout(LAYOUT_PATH %>% paste0("Exp0865.1--20200811_Nsp3_mac1_fragments_batch1_layout.csv"))) %>%
  filter(channel_f == "TAMRA",
         compound_group != "Empty") %>%
  mutate_all(convert_numerics) 

SYPRO_batch2_tms <- SYPRO_batch_2$fits$df_tms %>%
    select(variable:channel_f,dRFU_tma) %>%
  left_join(make_layout(LAYOUT_PATH %>% paste0("Exp0865.2--20200811_Nsp3_mac1_fragments_batch2_layout.csv"))) %>%
  filter(channel_f == "TAMRA",
         compound_group != "Empty") %>%
  mutate_all(convert_numerics) 

SYPRO_all_hits <- bind_rows(SYPRO_batch1_tms, SYPRO_batch2_tms)

SYPRO_all_hits %>%
  ggplot(aes(x = compound, y = dRFU_tma, color = compound_group, group = compound, shape = concentration %>% as.character(), size = concentration %>% as.character())) +
  scale_shape_manual(values = c(16, 16, 16, 1, 16, 1)) +
  scale_size_manual(values = c(3, 3, 3, 1.5, 3, 1.5)) +
  geom_point( alpha = 0.5) +
  geom_line(size=  0.5, alpha = 0.5) +
    theme_bw() +
  theme(axis.text.x = element_blank()) +
  ylim(c(40, 55)) +
  labs(title = "SYPRO dRFU Tmas") -> p_SYPRO

ggsave("Exp0866--20200815_SYPRO_dRFU_scatter_.pdf", p_SYPRO, width = 20, height = 4)

T004_batch1_tms <- T004_batch_1$fits$df_tms %>%
    select(variable:channel_f,dRFU_tma) %>%
  left_join(make_layout(LAYOUT_PATH %>% paste0("Exp0865.1--20200811_Nsp3_mac1_fragments_batch1_layout.csv"))) %>%
  filter(channel_f == "FAM",
         compound_group != "Empty") %>%
  mutate_all(convert_numerics) 

T004_batch2_tms <- T004_batch_2$fits$df_tms %>%
    select(variable:channel_f,dRFU_tma) %>%
  left_join(make_layout(LAYOUT_PATH %>% paste0("Exp0865.2--20200811_Nsp3_mac1_fragments_batch2_layout.csv"))) %>%
  filter(channel_f == "FAM",
         compound_group != "Empty") %>%
  mutate_all(convert_numerics) 

T004_all_hits <- bind_rows(T004_batch1_tms, T004_batch2_tms)

T004_all_hits %>%
  ggplot(aes(x = compound, y = dRFU_tma, color = compound_group, group = compound, shape = concentration %>% as.character(), size = concentration %>% as.character())) +
  scale_shape_manual(values = c(16, 16, 16, 1, 16, 1)) +
  scale_size_manual(values = c(3, 3, 3, 1.5, 3, 1.5)) +
  geom_point( alpha = 0.5) +
  geom_line(size=  0.5, alpha = 0.5) +
    theme_bw() +
  theme(axis.text.x = element_blank()) +
  ylim(c(40, 55)) +
  labs(title = "T004 dRFU Tmas") -> p_T4
ggsave("Exp0866--20200815_T004_dRFU_scatter_.pdf", p_T4, width = 20, height = 4)


all_hits <- bind_rows(T004_all_hits %>% mutate(dye = "T004") %>% filter(channel_f == "FAM"), 
                      SYPRO_all_hits %>% mutate(dye = "SYPRO") %>% filter(channel_f == "TAMRA"))

all_hits %>%
  ggplot(aes(x = compound, y = dRFU_tma, color = dye, group = compound, shape = concentration %>% as.character(), size = concentration %>% as.character())) +
  scale_shape_manual(values = c(16, 16, 16, 1, 16, 1)) +
  scale_size_manual(values = c(3, 3, 3, 1.5, 3, 1.5)) +
  geom_point( alpha = 0.5) +
  geom_line(size=  0.5, alpha = 0.5) +
    theme_bw() +
  theme(axis.text.x = element_blank()) +
  ylim(c(40, 55)) -> p_compare

ggsave("Exp0866--20200815_SYPRO_T004_dRFU_scatter_compare.pdf", p_compare, width = 20, height = 4)

all_hits %>%
  filter(compound_group == "test") %>%
  select(-c(condition, channel_f, variable)) %>%
  pivot_wider(names_from = dye, values_from = dRFU_tma) %>%
   bind_rows(all_controls) %>%
   ggplot(aes(y = T004, x = SYPRO,  group = compound, color = compound_group, shape = concentration %>% as.character(), size = concentration %>% as.character())) +
  scale_shape_manual(values = c(16, 16, 1, 1, 1, 1)) +
  scale_size_manual(values = c(2, 2, 3, 1.5, 3, 1.5)) +
  geom_line(size = 0.5, alpha = 0.7) +
  #ggplot(aes(x = T004, y = SYPRO)) +
  geom_point(alpha = 0.7) +
  coord_fixed() +
  ylim(c(47.5, 55)) +
  xlim(c(47.5, 55)) +
  geom_abline(slope = 1, intercept = 0, alpha = 0.5)


T004_controls <- all_hits %>%
filter(compound_group != "test",
       dye == "T004") %>%
  select(-c(condition, channel_f, variable))  %>%
   rename(T004 = "dRFU_tma")

SYPRO_controls <- all_hits %>%
filter(compound_group != "test",
       dye == "SYPRO") %>%
  select(-c(condition, channel_f, variable)) %>%
  rename(SYPRO = "dRFU_tma")

all_controls <- left_join(T004_controls, SYPRO_controls %>% select(well, "SYPRO"), by = "well")
all_controls


```











Make the BIC plots for all of the fitted models
```{r}
df_models <- bind_rows(s1_list$df_models, 
                               s1_d_list$df_models, 
                               s2_list$df_models, 
                               s2_d_list$df_models) %>%
                select(well, Temperature, Temperature_norm, pred, value_norm, condition, which_model, component) %>%
                left_join(layout, by =  c("condition", "well")) %>%
                filter(protein == "Nsp3",
                     dye == "SYPRO",
                     compound != "Empty")

df_BIC_models <-bind_rows(s1_list$df_BIC, 
                               s1_d_list$df_BIC, 
                               s2_list$df_BIC, 
                               s2_d_list$df_BIC) %>%
                  left_join(layout, by = c("condition", "well")) %>%
                  filter(protein == "Nsp3",
                         dye == "SYPRO",
                         compound != "Empty")

df_BIC_models_p <- df_BIC_models %>% cond_df_BIC_for_plot (  ) 

df_tm_models <- bind_rows(s1_list$tm_table_models, 
                               s1_d_list$tm_table_models, 
                               s2_list$tm_table_models, 
                               s2_d_list$tm_table_models) %>%
                left_join(layout, by = "condition") %>%
                filter(protein == "Nsp3",
                       dye == "SYPRO",
                       compound != "Empty")

        df_BIC_models_p <- df_BIC_models %>%
                                        cond_df_BIC_for_plot (  ) 

  
df_models_p <- cond_df_model_for_plot( df_models, df_BIC_models) %>%
                          left_join(layout, by = c("condition", "well"))
  

p_BIC_out <- plot_all_fits_shiny( df_models_p, df_BIC_models_p )
      ggsave("test_p_bic.pdf", p_BIC_out, height = 100, width = 15, limitsize = FALSE)

p_BIC_out_controls <- plot_all_fits_shiny( df_models_p %>% filter(compound_group != "test"), df_BIC_models_p %>% filter(compound_group != "test"))
 ggsave("test_p_bic_controls.pdf", p_BIC_out_controls , height = 20, width = 15, limitsize = FALSE)

p_BIC_out <- plot_all_fits_shiny( df_models_p, df_BIC_models_p )

df_BIC_models_p  %>% head()
df_models_p %>% head()

```



Make a more informed scatter plot incorporating parameters from the models (shape calling?)
```{r}

```


```{r}



SYPRO_batch_1$df_raw %>%
  filter(channel == 'TAMRA',
         dye == 'SYPRO',
         Temperature == 25) %>%
  ggplot(aes(x = condition, y = value, color = compound_group, shape = protein)) +
  geom_point(alpha = 0.25) +
  scale_shape_manual(values = c("Nsp3" = 16, "Buffer" = 1))+
  theme(axis.text.x = element_blank())


df_raw %>%
  filter(channel == 'TAMRA',
         dye == 'SYPRO',
         Temperature == 25) %>%
  ggplot(aes(x = condition, y = value_norm, color = compound_group, shape = protein)) +
  geom_point(alpha = 0.25) +
  scale_shape_manual(values = c("Nsp3" = 16, "Buffer" = 1))+
  theme(axis.text.x = element_blank())


df_raw %>%
  filter(channel == 'TAMRA',
         dye == 'SYPRO',
         Temperature == 25,
         compound_group == "test") %>%
  select(compound, protein, value) %>%
  pivot_wider(values_from = value, names_from = protein) %>%
  mutate(delta_25 = Nsp3 - Buffer) %>%
  ggplot(aes(x = compound, y = delta_25)) +
  geom_point(alpha = 0.25) +
  scale_shape_manual(values = c("Nsp3" = 16, "Buffer" = 1))+
  theme(axis.text.x = element_blank())
 
```










